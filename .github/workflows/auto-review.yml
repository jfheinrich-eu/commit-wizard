name: Automated Bot Review

# Trigger when all checks are successful and PR is ready for review
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review (optional, will auto-detect if not provided)"
        required: false
        type: string
  pull_request:
    types:
      - ready_for_review
      - synchronize
  check_suite:
    types:
      - completed
  workflow_run:
    workflows: ["Rust Tests"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-review:
    name: Auto Review by Bot
    runs-on: ubuntu-latest
    env:
      # If you set BOT_TOKEN, it will be used instead of GITHUB_TOKEN.
      # BOT_TOKEN should have the minimum required permissions (ideally: 'repo' and 'pull_request:write' only).
      # Avoid using a token with admin or organization-wide permissions.
      # See https://docs.github.com/en/actions/security-guides/automatic-token-authentication for details.
      GH_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}

    # Set bash as default shell for all run steps in this job
    defaults:
      run:
        shell: bash

    # Only run on pull requests that are ready for review and not in draft mode
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          # Fetch full history for better context
          fetch-depth: 0

      - name: Validate and get PR number
        id: get-pr
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER_DIRECT: ${{ github.event.pull_request.number }}
          PR_NUMBER_INPUT: ${{ github.event.inputs.pr_number }}
          PR_DRAFT: ${{ github.event.pull_request.draft }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          # Use environment variables to avoid code injection
          CHECK_SUITE_PRS: ${{ toJson(github.event.check_suite.pull_requests) }}
          WORKFLOW_RUN_PRS: ${{ toJson(github.event.workflow_run.pull_requests) }}
        run: |
          set -euo pipefail

          # Validate conditions based on event type
          case "$EVENT_NAME" in
            "workflow_dispatch")
              # Manual trigger - use provided PR number or try to detect from current branch
              if [[ -n "$PR_NUMBER_INPUT" ]]; then
                echo "pr_number=$PR_NUMBER_INPUT" >> "$GITHUB_OUTPUT"
              else
                # Try to auto-detect PR from current context
                # Use GitHub context variables instead of git command to avoid detached HEAD issues
                CURRENT_BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
                echo "Trying to auto-detect PR for branch: $CURRENT_BRANCH"
                PR_NUM=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number // empty' || echo "")
                if [[ -n "$PR_NUM" ]]; then
                  echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
                else
                  echo "No PR number provided and could not auto-detect. Please provide pr_number input."
                  exit 0
                fi
              fi
              ;;
            "pull_request")
              if [[ "$PR_DRAFT" == "true" ]]; then
                echo "Skipping draft PR"
                exit 0
              fi
              echo "pr_number=$PR_NUMBER_DIRECT" >> "$GITHUB_OUTPUT"
              ;;
            "check_suite"|"workflow_run")
              # Parse JSON to check if PRs exist
              if [[ "$EVENT_NAME" == "check_suite" ]]; then
                PRS_JSON="$CHECK_SUITE_PRS"
              else
                PRS_JSON="$WORKFLOW_RUN_PRS"
              fi

              # Check if PRs array is not empty
              if echo "$PRS_JSON" | jq -e '. | length > 0' > /dev/null; then
                PR_NUM=$(echo "$PRS_JSON" | jq -r '.[0].number')
                echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
              else
                echo "No PRs associated with this event"
                exit 0
              fi
              ;;
          esac

      - name: Check all required checks status
        id: check-status
        if: steps.get-pr.outputs.pr_number
        env:
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          set -euo pipefail

          ACTIONS_STEP_DEBUG="${ACTIONS_STEP_DEBUG:=false}"

          # Get PR details using GitHub CLI
          PR_DATA=$(gh pr view "$PR_NUMBER" --json state,isDraft,mergeable,statusCheckRollup)

          # Check if PR is still open and not draft
          STATE=$(echo "$PR_DATA" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.isDraft')

          if [ "$STATE" != "OPEN" ]; then
            echo "PR is not open (state: $STATE), skipping review"
            echo "can_review=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR is in draft mode, skipping review"
            echo "can_review=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Debug: Show raw PR data
          echo "DEBUG: Raw PR data:"
          echo "$PR_DATA" | jq '.'

          # Check status of all required checks
          STATUS_CHECKS=$(echo "$PR_DATA" | jq -r '.statusCheckRollup // []')
          TOTAL_CHECKS=$(echo "$STATUS_CHECKS" | jq 'length')

          echo "Found $TOTAL_CHECKS status checks"
          echo "DEBUG: Status checks:"
          echo "$STATUS_CHECKS" | jq '.'

          # Alternative approach: Check commit status directly via API
          COMMIT_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          echo "Checking commit status for SHA: $COMMIT_SHA"

          # Get commit status and check runs for this specific PR
          COMMIT_STATUS=$(gh api "/repos/${{ github.repository }}/commits/$COMMIT_SHA/status" --jq '.state // "unknown"')

          # Get all check runs for this commit
          ALL_CHECK_RUNS=$(gh api "/repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs" --jq '.check_runs')

          # Filter check runs to only include those from pull requests matching this PR
          # This ensures we only check jobs that belong to this PR
          CHECK_RUNS=$(echo "$ALL_CHECK_RUNS" | jq --arg pr "$PR_NUMBER" '[.[] | select(.pull_requests // [] | any(.number == ($pr | try tonumber // 0)))]')
          CHECK_RUNS_COUNT=$(echo "$CHECK_RUNS" | jq 'length')

          echo "Commit status: $COMMIT_STATUS"
          echo "Total check runs for this PR: $CHECK_RUNS_COUNT"
          if [ "${ACTIONS_STEP_DEBUG}" = "true" ]; then
            echo "DEBUG: Check runs for PR #$PR_NUMBER:"
            echo "$CHECK_RUNS" | jq '.'
          fi

          # Count check runs by status, excluding this workflow (auto-review)
          SUCCESSFUL_RUNS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.name != "Auto Review by Bot" and .conclusion == "success")] | length')
          FAILED_RUNS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.name != "Auto Review by Bot" and .conclusion == "failure")] | length')
          PENDING_RUNS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.name != "Auto Review by Bot" and (.status == "in_progress" or .status == "queued" or .conclusion == null))] | length')
          OTHER_RUNS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.name != "Auto Review by Bot")] | length')

          echo "Check runs analysis for this PR:"
          echo "  - Total (excluding auto-review): $OTHER_RUNS"
          echo "  - Successful: $SUCCESSFUL_RUNS"
          echo "  - Failed: $FAILED_RUNS"
          echo "  - Pending: $PENDING_RUNS"

          # Decision logic:
          # 1. If there are no other check runs (only auto-review), proceed with review
          if [ "$OTHER_RUNS" -eq 0 ]; then
            echo "âœ… No other check runs found for this PR - proceeding with review"
            echo "can_review=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 2. If any check runs have failed, skip review
          if [ "$FAILED_RUNS" -gt 0 ]; then
            echo "âŒ $FAILED_RUNS check run(s) have failed - skipping review"
            echo "can_review=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 3. If any check runs are still pending, skip review for now
          if [ "$PENDING_RUNS" -gt 0 ]; then
            echo "â³ $PENDING_RUNS check run(s) are still pending - skipping review for now"
            echo "can_review=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 4. All other checks passed, we can review
          if [ "$SUCCESSFUL_RUNS" -gt 0 ]; then
            echo "âœ… All $SUCCESSFUL_RUNS check run(s) succeeded - proceeding with review"
            echo "can_review=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 5. Fallback: No check runs found (edge case), check commit status
          echo "No check runs found, checking commit status..."
          case "$COMMIT_STATUS" in
            "success")
              echo "âœ… Commit status is success - proceeding with review"
              echo "can_review=true" >> "$GITHUB_OUTPUT"
              ;;
            "pending")
              echo "â³ Commit status is pending - skipping review for now"
              echo "can_review=false" >> "$GITHUB_OUTPUT"
              ;;
            "failure"|"error")
              echo "âŒ Commit status is $COMMIT_STATUS - skipping review"
              echo "can_review=false" >> "$GITHUB_OUTPUT"
              ;;
            *)
              # Unknown or no status - proceed (e.g., no required status checks)
              echo "â„¹ï¸ Commit status unknown ($COMMIT_STATUS) - proceeding with review"
              echo "can_review=true" >> "$GITHUB_OUTPUT"
              ;;
          esac
      - name: Check if bot already reviewed current commit
        id: check-reviewed
        if: steps.check-status.outputs.can_review == 'true'
        env:
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          set -euo pipefail

          # Dynamically determine the bot's username from the token
          BOT_USERNAME=$(gh api user --jq '.login')
          echo "Detected bot username: $BOT_USERNAME"

          # Get current HEAD commit SHA of the PR
          CURRENT_COMMIT=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          echo "Current PR HEAD commit: $CURRENT_COMMIT"

          # Get all reviews from the bot with their commit SHAs
          REVIEWS_DATA=$(gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" --jq "[.[] | select(.user.login == \"$BOT_USERNAME\") | {commit_id: .commit_id, state: .state}]")

          echo "Bot reviews found:"
          echo "$REVIEWS_DATA" | jq '.'

          # Check if there's an APPROVED review for the current commit
          CURRENT_COMMIT_APPROVED=$(echo "$REVIEWS_DATA" | jq --arg commit "$CURRENT_COMMIT" '[.[] | select(.commit_id == $commit and .state == "APPROVED")] | length')

          if [ "$CURRENT_COMMIT_APPROVED" -gt 0 ]; then
            echo "âœ… Bot has already approved the current commit ($CURRENT_COMMIT)"
            echo "already_reviewed=true" >> "$GITHUB_OUTPUT"
          else
            echo "â³ Bot has not approved the current commit yet (new commits pushed or no review yet)"
            echo "already_reviewed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Perform automated review
        if: |
          steps.check-status.outputs.can_review == 'true' &&
          steps.check-reviewed.outputs.already_reviewed == 'false'
        env:
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          set -euo pipefail

          # Get PR details for the review comment
          PR_DATA=$(gh pr view "$PR_NUMBER" --json title,author,headRefName,additions,deletions)
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          ADDITIONS=$(echo "$PR_DATA" | jq -r '.additions')
          DELETIONS=$(echo "$PR_DATA" | jq -r '.deletions')

          # Create review comment with properly escaped values
          # Escape all variables that come from PR metadata using jq
          PR_TITLE_ESCAPED=$(echo "$PR_DATA" | jq -r '.title | @text')
          PR_AUTHOR_ESCAPED=$(echo "$PR_DATA" | jq -r '.author.login | @text')
          PR_BRANCH_ESCAPED=$(echo "$PR_DATA" | jq -r '.headRefName | @text')
          ADDITIONS_ESCAPED=$(echo "$PR_DATA" | jq -r '.additions | tostring')
          DELETIONS_ESCAPED=$(echo "$PR_DATA" | jq -r '.deletions | tostring')

          # Use heredoc with variable substitution disabled, then replace placeholders
          REVIEW_BODY=$(cat <<'EOF'
          ## ðŸ¤– Automated Bot Review

          **Status:** âœ… All checks passed

          ### Pull Request: __PR_TITLE__

          ### Summary
          - **Author:** @__PR_AUTHOR__
          - **Branch:** `__PR_BRANCH__`
          - **Changes:** +__ADDITIONS__ / -__DELETIONS__ lines

          ### Automated Checks
          All required status checks have completed successfully. This PR is ready for human review.

          ### Next Steps
          - Code owner review is required from: **@jfheinrich-eu/maintainers**

          ---
          *This is an automated review. Please wait for human reviewers to approve before merging.*

          EOF
          )

          # Replace placeholders with escaped values
          REVIEW_BODY="${REVIEW_BODY//__PR_TITLE__/$PR_TITLE_ESCAPED}"
          REVIEW_BODY="${REVIEW_BODY//__PR_AUTHOR__/$PR_AUTHOR_ESCAPED}"
          REVIEW_BODY="${REVIEW_BODY//__PR_BRANCH__/$PR_BRANCH_ESCAPED}"
          REVIEW_BODY="${REVIEW_BODY//__ADDITIONS__/$ADDITIONS_ESCAPED}"
          REVIEW_BODY="${REVIEW_BODY//__DELETIONS__/$DELETIONS_ESCAPED}"

          # Submit the review
          gh pr review "$PR_NUMBER" --approve --body "$REVIEW_BODY"

          echo "âœ… Automated review submitted successfully"

      - name: Add review label
        if: |
          steps.check-status.outputs.can_review == 'true' &&
          steps.check-reviewed.outputs.already_reviewed == 'false'
        env:
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          set -euo pipefail

          # Add 'automated' label to indicate bot has reviewed
          # Only add the label if it is not already present
          EXISTING_LABELS=$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name')
          if ! echo "$EXISTING_LABELS" | grep -qx "automated"; then
            gh pr edit "$PR_NUMBER" --add-label "automated"
            echo "âœ… Added 'automated' label to PR"
          else
            echo "â„¹ï¸ 'automated' label already present on PR"
          fi

      - name: Handle errors gracefully
        if: failure()
        env:
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          set -e

          # Only post comment if we have a PR number
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            gh pr comment "$PR_NUMBER" --body "## âš ï¸ Automated Review Failed

          The automated review process encountered an error. Please check the workflow logs for details.

          You can still proceed with manual review by the code owners and maintainers." || echo "Warning: Could not post error comment to PR"
          fi

          echo "âš ï¸ Workflow failed but error was handled gracefully"
